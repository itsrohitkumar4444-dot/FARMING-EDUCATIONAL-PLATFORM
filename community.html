<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - GreenFarm</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f9fbf9;
            line-height: 1.6;
            color: #333;
        }

        /* Navbar */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 10%;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2ecc71;
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #2c3e50;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: #2ecc71;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 30px;
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .sidebar h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .sidebar-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            color: #555;
        }

        .sidebar-item:hover, .sidebar-item.active {
            background: #e8f5e9;
            color: #2ecc71;
        }

        .sidebar-icon {
            font-size: 1.3rem;
        }

        /* Main Feed */
        .main-feed {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        /* Create Post */
        .create-post {
            background: #f9fbf9;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .create-post textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            outline: none;
            transition: border 0.3s ease;
        }

        .create-post textarea:focus {
            border-color: #2ecc71;
        }

        .create-post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .post-options {
            display: flex;
            gap: 15px;
        }

        .post-option {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.5rem;
            transition: color 0.3s ease;
        }

        .post-option:hover {
            color: #2ecc71;
        }

        .btn-post {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-post:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        /* Posts */
        .posts-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .post-card {
            background: white;
            border: 1px solid #f0f0f0;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .post-card:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .post-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .post-author-info {
            flex: 1;
        }

        .post-author {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.05rem;
        }

        .post-time {
            color: #999;
            font-size: 0.85rem;
        }

        .follow-btn {
            background: white;
            color: #2ecc71;
            border: 2px solid #2ecc71;
            padding: 6px 18px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .follow-btn:hover {
            background: #2ecc71;
            color: white;
        }

        .follow-btn.following {
            background: #2ecc71;
            color: white;
        }

        .post-content {
            color: #444;
            line-height: 1.8;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .post-image {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 15px;
            max-height: 400px;
            object-fit: cover;
        }

        .post-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .post-tag {
            background: #e8f5e9;
            color: #2ecc71;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .post-actions {
            display: flex;
            gap: 25px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #666;
            font-weight: 500;
            transition: color 0.3s ease;
            padding: 8px 12px;
            border-radius: 8px;
            background: none;
            border: none;
            font-size: 0.95rem;
        }

        .post-action:hover {
            background: #f9fbf9;
            color: #2ecc71;
        }

        .post-action.liked {
            color: #e74c3c;
        }

        .action-icon {
            font-size: 1.2rem;
        }

        /* Comments Section */
        .comments-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
            display: none;
        }

        .comments-section.show {
            display: block;
        }

        .comment-input-wrapper {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .comment-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            outline: none;
            font-size: 0.95rem;
            transition: border 0.3s ease;
        }

        .comment-input:focus {
            border-color: #2ecc71;
        }

        .btn-comment {
            background: #2ecc71;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-comment:hover {
            background: #27ae60;
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comment {
            display: flex;
            gap: 12px;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
            background: #f9fbf9;
            padding: 12px 16px;
            border-radius: 12px;
        }

        .comment-author {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .comment-text {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .comment-time {
            color: #999;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* Right Sidebar */
        .right-sidebar {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .widget {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .widget h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .suggested-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: background 0.3s ease;
        }

        .suggested-user:hover {
            background: #f9fbf9;
        }

        .suggested-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .suggested-info {
            flex: 1;
        }

        .suggested-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .suggested-title {
            color: #999;
            font-size: 0.8rem;
        }

        .btn-follow-small {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-follow-small:hover {
            background: #27ae60;
        }

        .trending-item {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .trending-item:hover {
            background: #f9fbf9;
        }

        .trending-tag {
            color: #2ecc71;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .trending-count {
            color: #999;
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }

            .sidebar, .right-sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 15px 5%;
                flex-direction: column;
                gap: 15px;
            }

            .container {
                padding: 0 10px;
                margin: 20px auto;
            }

            .main-feed {
                padding: 20px;
            }

            .post-actions {
                flex-wrap: wrap;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <div class="navbar">
        <div class="logo" onclick="window.location.href='index2.html'">üå± GreenFarm</div>
        <div class="nav-links">
            <a href="index2.html" id="navHomeLink">Home</a>
            <a href="Dashboard.html">Dashboard</a>
            <a href="experts.html">Experts</a>
            <a href="community.html">Community</a>
            <a href="certificates.html">Certifications</a>
            <button class="logout-btn" onclick="logoutUser()">Logout</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <h3>Navigation</h3>
            <div class="sidebar-item active" data-filter="all">
                <span class="sidebar-icon">üè†</span>
                <span>Home Feed</span>
            </div>
            <div class="sidebar-item" data-filter="following">
                <span class="sidebar-icon">üë•</span>
                <span>Following</span>
            </div>
            <div class="sidebar-item" data-filter="popular">
                <span class="sidebar-icon">üî•</span>
                <span>Popular</span>
            </div>
            <div class="sidebar-item" data-filter="my-posts">
                <span class="sidebar-icon">‚úçÔ∏è</span>
                <span>My Posts</span>
            </div>
        </aside>

        <!-- Main Feed -->
        <main class="main-feed">
            <!-- Create Post -->
            <div class="create-post">
                <textarea id="postContent" placeholder="Share your farming insights, questions, or experiences..."></textarea>
                <div class="create-post-actions">
                    <div class="post-options">
                        <button class="post-option" title="Add Image">üì∑</button>
                        <button class="post-option" title="Add Location">üìç</button>
                        <button class="post-option" title="Add Tags">üè∑Ô∏è</button>
                    </div>
                    <button class="btn-post" onclick="createPost()">Post</button>
                </div>
            </div>

            <!-- Posts Feed -->
            <div class="posts-container" id="postsContainer">
                <!-- Posts will be loaded dynamically -->
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="right-sidebar">
            <!-- Suggested People -->
            <div class="widget">
                <h3>Suggested for You</h3>
                <div id="suggestedUsers">
                    <!-- Suggested users will be loaded here -->
                </div>
            </div>

            <!-- Trending Topics -->
            <div class="widget">
                <h3>üî• Trending Topics</h3>
                <div class="trending-item">
                    <div class="trending-tag">#OrganicFarming</div>
                    <div class="trending-count">1,234 posts</div>
                </div>
                <div class="trending-item">
                    <div class="trending-tag">#WaterConservation</div>
                    <div class="trending-count">892 posts</div>
                </div>
                <div class="trending-item">
                    <div class="trending-tag">#SoilHealth</div>
                    <div class="trending-count">756 posts</div>
                </div>
                <div class="trending-item">
                    <div class="trending-tag">#ClimateAdaptation</div>
                    <div class="trending-count">634 posts</div>
                </div>
            </div>
        </aside>

    </div>

    <script src="auth.js"></script>
    <script>
        // Require authentication
        if (!isUserLoggedIn()) {
            sessionStorage.setItem('greenfarm_redirect', window.location.pathname);
            alert('Please sign in to access the community.');
            window.location.href = 'signin.html';
        }

        const currentUser = getCurrentUser();

        // Get posts from localStorage
        function getPosts() {
            const posts = localStorage.getItem('greenfarm_posts');
            return posts ? JSON.parse(posts) : getSamplePosts();
        }

        function savePosts(posts) {
            localStorage.setItem('greenfarm_posts', JSON.stringify(posts));
        }

        // Get likes from localStorage
        function getLikes() {
            const likes = localStorage.getItem('greenfarm_likes');
            return likes ? JSON.parse(likes) : [];
        }

        function saveLikes(likes) {
            localStorage.setItem('greenfarm_likes', JSON.stringify(likes));
        }

        // Get comments from localStorage
        function getComments() {
            const comments = localStorage.getItem('greenfarm_comments');
            return comments ? JSON.parse(comments) : [];
        }

        function saveComments(comments) {
            localStorage.setItem('greenfarm_comments', JSON.stringify(comments));
        }

        // Get user follows
        function getUserFollows() {
            const follows = localStorage.getItem('greenfarm_user_follows');
            return follows ? JSON.parse(follows) : [];
        }

        function saveUserFollows(follows) {
            localStorage.setItem('greenfarm_user_follows', JSON.stringify(follows));
        }

        function isFollowingUser(userId) {
            const follows = getUserFollows();
            return follows.some(f => f.followerId === currentUser.id && f.followingId === userId);
        }

        // Get expert follows (from experts page)
        function getExpertFollows() {
            const follows = localStorage.getItem('greenfarm_following');
            return follows ? JSON.parse(follows) : [];
        }

        function isFollowingExpert(expertId) {
            const follows = getExpertFollows();
            return follows.some(f => f.userId === currentUser.id && f.expertId === expertId);
        }

        // Sample posts
        function getSamplePosts() {
            return [
                {
                    id: 'post_' + Date.now() + '_1',
                    author: 'Dr. Priya Sharma',
                    authorId: 'exp001',
                    avatar: 'PS',
                    isExpert: true,
                    content: 'Just completed a successful trial of companion planting with marigolds and tomatoes. The marigolds acted as natural pest deterrents and we saw a 40% reduction in aphid damage! üåºüçÖ #OrganicFarming #CompanionPlanting',
                    tags: ['OrganicFarming', 'CompanionPlanting'],
                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                    likesCount: 45,
                    commentsCount: 8
                },
                {
                    id: 'post_' + Date.now() + '_2',
                    author: 'Rajesh Kumar',
                    authorId: 'exp002',
                    avatar: 'RK',
                    isExpert: true,
                    content: 'Sharing my latest permaculture design for a 2-acre farm. Key features: rainwater harvesting swales, food forest on contours, and integrated livestock. DM me if you want the detailed plans! üåø #Permaculture #SustainableDesign',
                    tags: ['Permaculture', 'SustainableDesign'],
                    timestamp: new Date(Date.now() - 7200000).toISOString(),
                    likesCount: 67,
                    commentsCount: 12
                },
                {
                    id: 'post_' + Date.now() + '_3',
                    author: 'Maya Singh',
                    authorId: 'exp005',
                    avatar: 'MS',
                    isExpert: true,
                    content: 'Quick tip: Adding indigenous microorganisms to your compost can speed up decomposition by 50%! I\'ve been testing this for 3 months and the results are incredible. The soil health improvement is remarkable. üî¨üå± #SoilScience #Composting',
                    tags: ['SoilScience', 'Composting'],
                    timestamp: new Date(Date.now() - 10800000).toISOString(),
                    likesCount: 89,
                    commentsCount: 15
                },
                {
                    id: 'post_' + Date.now() + '_4',
                    author: 'Suresh Patel',
                    authorId: 'exp004',
                    avatar: 'SP',
                    isExpert: true,
                    content: 'Installed a drip irrigation system on a 5-acre farm last week. Water usage decreased by 60% while crop yield increased by 25%! Micro-irrigation is the future for water-scarce regions. üíß #WaterManagement #Irrigation',
                    tags: ['WaterManagement', 'Irrigation'],
                    timestamp: new Date(Date.now() - 14400000).toISOString(),
                    likesCount: 52,
                    commentsCount: 9
                },
                {
                    id: 'post_' + Date.now() + '_5',
                    author: 'Dr. Anjali Mehta',
                    authorId: 'exp003',
                    avatar: 'AM',
                    isExpert: true,
                    content: 'New research shows that crop diversification is key to climate resilience. Farmers who grow 5+ crop varieties are 70% more likely to withstand extreme weather. Planning is everything! üåç #ClimateAdaptation #CropDiversification',
                    tags: ['ClimateAdaptation', 'CropDiversification'],
                    timestamp: new Date(Date.now() - 18000000).toISOString(),
                    likesCount: 98,
                    commentsCount: 20
                }
            ];
        }

        // Create post
        function createPost() {
            const content = document.getElementById('postContent').value.trim();
            
            if (!content) {
                alert('Please write something before posting!');
                return;
            }

            const posts = getPosts();
            const newPost = {
                id: 'post_' + Date.now(),
                author: currentUser.fullName,
                authorId: currentUser.id,
                avatar: currentUser.fullName.substring(0, 2).toUpperCase(),
                content: content,
                tags: extractHashtags(content),
                timestamp: new Date().toISOString(),
                likesCount: 0,
                commentsCount: 0
            };

            posts.unshift(newPost);
            savePosts(posts);

            // Add activity
            addActivity({
                type: 'community_post',
                description: 'Posted in community',
                icon: 'üí¨'
            });

            document.getElementById('postContent').value = '';
            renderPosts();
        }

        function extractHashtags(text) {
            const hashtagRegex = /#(\w+)/g;
            const matches = text.match(hashtagRegex);
            return matches ? matches.map(tag => tag.substring(1)) : [];
        }

        // Render posts
        function renderPosts(filter = 'all') {
            const container = document.getElementById('postsContainer');
            let posts = getPosts();

            // Apply filter
            if (filter === 'my-posts') {
                posts = posts.filter(p => p.authorId === currentUser.id);
            } else if (filter === 'following') {
                // Get both user follows and expert follows
                const userFollows = getUserFollows();
                const expertFollows = getExpertFollows();
                
                // Get IDs of users being followed
                const followingUserIds = userFollows
                    .filter(f => f.followerId === currentUser.id)
                    .map(f => f.followingId);
                
                // Get IDs of experts being followed
                const followingExpertIds = expertFollows
                    .filter(f => f.userId === currentUser.id)
                    .map(f => f.expertId);
                
                // Combine both lists
                const allFollowingIds = [...followingUserIds, ...followingExpertIds];
                
                // Filter posts from followed users and experts
                posts = posts.filter(p => allFollowingIds.includes(p.authorId));
                
                if (posts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <h3>No posts from people you follow</h3>
                            <p>Start following experts and community members to see their posts here!</p>
                            <button class="btn-post" onclick="window.location.href='experts.html'" style="margin-top: 20px;">Browse Experts</button>
                        </div>
                    `;
                    return;
                }
            } else if (filter === 'popular') {
                posts = posts.sort((a, b) => b.likesCount - a.likesCount);
            }

            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No posts yet</h3>
                        <p>Be the first to share something!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = posts.map(post => {
                const likes = getLikes();
                const isLiked = likes.some(l => l.postId === post.id && l.userId === currentUser.id);
                const comments = getComments().filter(c => c.postId === post.id);
                const isFollowing = post.authorId !== currentUser.id && (isFollowingUser(post.authorId) || isFollowingExpert(post.authorId));

                return `
                    <div class="post-card" data-post-id="${post.id}">
                        <div class="post-header">
                            <div class="post-avatar">${post.avatar}</div>
                            <div class="post-author-info">
                                <div class="post-author">${post.author}${post.isExpert ? ' <span style="color: #2ecc71; font-size: 0.9rem;">‚úì</span>' : ''}</div>
                                <div class="post-time">${getTimeAgo(post.timestamp)}</div>
                            </div>
                            ${post.authorId !== currentUser.id ? `
                                <button class="follow-btn ${isFollowing ? 'following' : ''}" onclick="toggleFollowUser('${post.authorId}', '${post.author}', ${post.isExpert || false})">
                                    ${isFollowing ? '‚úì Following' : '+ Follow'}
                                </button>
                            ` : ''}
                        </div>
                        <div class="post-content">${post.content}</div>
                        ${post.tags.length > 0 ? `
                            <div class="post-tags">
                                ${post.tags.map(tag => `<span class="post-tag">#${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div class="post-actions">
                            <button class="post-action ${isLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')">
                                <span class="action-icon">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                <span>${post.likesCount} ${post.likesCount === 1 ? 'Like' : 'Likes'}</span>
                            </button>
                            <button class="post-action" onclick="toggleComments('${post.id}')">
                                <span class="action-icon">üí¨</span>
                                <span>${comments.length} ${comments.length === 1 ? 'Comment' : 'Comments'}</span>
                            </button>
                            <button class="post-action">
                                <span class="action-icon">üîó</span>
                                <span>Share</span>
                            </button>
                        </div>
                        <div class="comments-section" id="comments-${post.id}">
                            <div class="comment-input-wrapper">
                                <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment...">
                                <button class="btn-comment" onclick="addComment('${post.id}')">Post</button>
                            </div>
                            <div class="comments-list" id="comments-list-${post.id}">
                                ${renderComments(post.id)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render comments
        function renderComments(postId) {
            const comments = getComments().filter(c => c.postId === postId);
            
            if (comments.length === 0) {
                return '<p style="text-align: center; color: #999; padding: 20px;">No comments yet. Be the first to comment!</p>';
            }

            return comments.map(comment => `
                <div class="comment">
                    <div class="comment-avatar">${comment.authorAvatar}</div>
                    <div class="comment-content">
                        <div class="comment-author">${comment.author}</div>
                        <div class="comment-text">${comment.text}</div>
                        <div class="comment-time">${getTimeAgo(comment.timestamp)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle like
        function toggleLike(postId) {
            let likes = getLikes();
            let posts = getPosts();
            const postIndex = posts.findIndex(p => p.id === postId);

            const likeIndex = likes.findIndex(l => l.postId === postId && l.userId === currentUser.id);

            if (likeIndex > -1) {
                // Unlike
                likes.splice(likeIndex, 1);
                posts[postIndex].likesCount--;
            } else {
                // Like
                likes.push({
                    postId: postId,
                    userId: currentUser.id,
                    timestamp: new Date().toISOString()
                });
                posts[postIndex].likesCount++;
            }

            saveLikes(likes);
            savePosts(posts);
            renderPosts(currentFilter);
        }

        // Toggle comments visibility
        function toggleComments(postId) {
            const commentsSection = document.getElementById('comments-' + postId);
            commentsSection.classList.toggle('show');
        }

        // Add comment
        function addComment(postId) {
            const input = document.getElementById('comment-input-' + postId);
            const text = input.value.trim();

            if (!text) {
                alert('Please write a comment!');
                return;
            }

            let comments = getComments();
            let posts = getPosts();
            const postIndex = posts.findIndex(p => p.id === postId);

            comments.push({
                id: 'comment_' + Date.now(),
                postId: postId,
                author: currentUser.fullName,
                authorAvatar: currentUser.fullName.substring(0, 2).toUpperCase(),
                text: text,
                timestamp: new Date().toISOString()
            });

            posts[postIndex].commentsCount++;

            saveComments(comments);
            savePosts(posts);
            
            input.value = '';
            document.getElementById('comments-list-' + postId).innerHTML = renderComments(postId);
            renderPosts(currentFilter);
        }

        // Toggle follow user (works for both regular users and experts)
        function toggleFollowUser(userId, userName, isExpert = false) {
            if (isExpert) {
                // Handle expert follows
                let expertFollows = getExpertFollows();
                const followIndex = expertFollows.findIndex(f => f.userId === currentUser.id && f.expertId === userId);

                if (followIndex > -1) {
                    // Unfollow expert
                    expertFollows.splice(followIndex, 1);
                    localStorage.setItem('greenfarm_following', JSON.stringify(expertFollows));
                } else {
                    // Follow expert
                    expertFollows.push({
                        userId: currentUser.id,
                        expertId: userId,
                        followedAt: new Date().toISOString()
                    });
                    localStorage.setItem('greenfarm_following', JSON.stringify(expertFollows));

                    addActivity({
                        type: 'expert_follow',
                        description: `Started following expert ${userName}`,
                        icon: 'üåü'
                    });
                }
            } else {
                // Handle regular user follows
                let follows = getUserFollows();
                const followIndex = follows.findIndex(f => f.followerId === currentUser.id && f.followingId === userId);

                if (followIndex > -1) {
                    // Unfollow
                    follows.splice(followIndex, 1);
                } else {
                    // Follow
                    follows.push({
                        followerId: currentUser.id,
                        followingId: userId,
                        timestamp: new Date().toISOString()
                    });

                    addActivity({
                        type: 'user_follow',
                        description: `Started following ${userName}`,
                        icon: 'üë§'
                    });
                }

                saveUserFollows(follows);
            }

            renderPosts(currentFilter);
        }

        // Load suggested users
        function loadSuggestedUsers() {
            const users = getUsers().filter(u => u.id !== currentUser.id && !u.isGuest);
            const container = document.getElementById('suggestedUsers');

            const suggested = users.slice(0, 5);

            container.innerHTML = suggested.map(user => {
                const isFollowing = isFollowingUser(user.id);
                return `
                    <div class="suggested-user">
                        <div class="suggested-avatar">${user.fullName.substring(0, 2).toUpperCase()}</div>
                        <div class="suggested-info">
                            <div class="suggested-name">${user.fullName}</div>
                            <div class="suggested-title">${user.role}</div>
                        </div>
                        ${!isFollowing ? `<button class="btn-follow-small" onclick="toggleFollowUser('${user.id}', '${user.fullName}'); loadSuggestedUsers();">Follow</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Time ago function
        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return then.toLocaleDateString();
        }

        // Sidebar filtering
        let currentFilter = 'all';
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                renderPosts(currentFilter);
            });
        });

        // Update navbar
        document.addEventListener('DOMContentLoaded', function() {
            const navHomeLink = document.getElementById('navHomeLink');
            if (isUserLoggedIn()) {
                navHomeLink.textContent = 'Dashboard';
                navHomeLink.href = 'Dashboard.html';
            }
        });

        // Initial render
        renderPosts();
        loadSuggestedUsers();
    </script>

</body>
</html>